const products = [{
    "name": "Soundcore_Liberty4 Pro",
    "price_range": "1万円以上",
    "noise": "欲しい",
    "noisepower": "強い",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "19,990",
    "url": "https://amzn.asia/d/bvdy9uF",
    "img": "img/Soundcore_Liberty4_Pro.png",
    "off": "https://www.ankerjapan.com/pages/soundcore-liberty4-pro"
}, {
    "name": "Soundcore_Liberty 5",
    "price_range": "1万円以上",
    "noise": "欲しい",
    "noisepower": "強い",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "14,990",
    "url": "https://amzn.asia/d/dobIacY",
    "img": "img/Soundcore_Liberty_5.png",
    "off": "https://www.ankerjapan.com/products/a3957"
}, {
    "name": "Soundcore P40i",
    "price_range": "1万円以下",
    "noise": "欲しい",
    "noisepower": "中程度",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "11~15時間",
    "prise": "7990",
    "url": "https://amzn.asia/d/geCGdga",
    "img": "img/Soundcore_P40i.png",
    "off": "https://www.ankerjapan.com/products/a3331"
}, {
    "name": "Soundcore_Sport X20",
    "price_range": "1万円以下",
    "noise": "いらない",
    "noisepower": "中程度",
    "purpose": "運動",
    "type": "あり",
    "playtime": "11~15時間",
    "prise": "9990",
    "url": "https://amzn.asia/d/fpOIFVN",
    "img": "img/Soundcore_Sport_X20.png",
    "off": "https://www.ankerjapan.com/products/a3968"
}, {
    "name": "Soundcore C40i",
    "price_range": "1万円以上",
    "noise": "いらない",
    "noisepower": "弱い",
    "purpose": "音楽鑑賞",
    "type": "なし",
    "playtime": "5~10時間",
    "prise": "12,990",
    "url": "https://amzn.asia/d/7z5A9Jr",
    "img": "img/Soundcore_C40i.png",
    "off": "https://www.ankerjapan.com/products/a3331"
}, {
    "name": "AirPods 4(ノイキャンモデル)",
    "price_range": "2万円以上",
    "noise": "欲しい",
    "noisepower": "強い",
    "purpose": "音楽鑑賞",
    "type": "なし",
    "playtime": "5~10時間",
    "prise": "29,800",
    "url": "https://amzn.asia/d/bpzAGn9",
    "img": "img/AirPods_4.png",
    "off": "https://x.gd/uZGUy"
}, {
    "name": "AirPods Pro 3",
    "price_range": "3万円以上",
    "noise": "欲しい",
    "noisepower": "強い",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "39,800",
    "url": "https://amzn.asia/d/dFlpvJK",
    "img": "img/AirPods_Pro_3.png",
    "off": "https://x.gd/Kv7iP"
}, {
    "name": "Beats Powerbeats_Pro 2",
    "price_range": "3万円以上",
    "noise": "いらない",
    "noisepower": "中程度",
    "purpose": "運動",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "39,800",
    "url": "https://amzn.asia/d/eeABYmz",
    "img": "img/Beats_Powerbeats_Pro_2.png",
    "off": "https://www.beatsbydre.com/jp/earbuds/powerbeats-pro-2/MX733/quick-sand"
}, {
    "name": "Beats SoloBuds",
    "price_range": "1万円以上",
    "noise": "いらない",
    "noisepower": "弱い",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "16時間以上",
    "prise": "12,800",
    "url": "https://amzn.asia/d/aHQ7SmU",
    "img": "img/Beats_SoloBuds.png",
    "off": "https://www.beatsbydre.com/jp/support/earbuds/solo-buds"
}, {
    "name": "Beats Studio_Buds +",
    "price_range": "2万円以上",
    "noise": "欲しい",
    "noisepower": "中程度",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "24,800",
    "url": "https://amzn.asia/d/8fjZJ6y",
    "img": "img/Beats_Studio_Buds_+.png",
    "off": "https://www.beatsbydre.com/jp/earbuds/studio-buds-plus-wireless-noise-cancelling"
}, {
    "name": "Beats Powerbeats Fit",
    "price_range": "2万円以上",
    "noise": "欲しい",
    "noisepower": "中程度",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "28,800",
    "url": "https://amzn.asia/d/cMcLDgO",
    "img": "img/Beats_Powerbeats_Fit.png",
    "off": "https://www.beatsbydre.com/jp/earbuds/powerbeats-fit"
}, {
    "name": "EarFunAirPro 4i",
    "price_range": "1万円以下",
    "noise": "欲しい",
    "noisepower": "中程度",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "8990",
    "url": "https://amzn.asia/d/1ohhQl4",
    "img": "img/EarFunAirPro_4i.png",
    "off": "https://x.gd/mRbte"
}, {
    "name": "EarFunClip",
    "price_range": "1万円以下",
    "noise": "いらない",
    "noisepower": "弱い",
    "purpose": "運動",
    "type": "なし",
    "playtime": "5~10時間",
    "prise": "7990",
    "url": "https://amzn.asia/d/82wpIfS",
    "img": "img/EarFunClip.png",
    "off": "https://www.myearfun.com/jp"
}, {
    "name": "EarFunOpenJump",
    "price_range": "1万円以下",
    "noise": "いらない",
    "noisepower": "弱い",
    "purpose": "運動",
    "type": "なし",
    "playtime": "11~15時間",
    "prise": "8990",
    "url": "https://amzn.asia/d/3FK08xu",
    "img": "img/EarFunOpenJump.png",
    "off": "https://x.gd/5zr1c"
}, {
    "name": "EarFunAirPro 4",
    "price_range": "1万円以上",
    "noise": "欲しい",
    "noisepower": "中程度",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "11~15時間",
    "prise": "11,990",
    "url": "https://amzn.asia/d/8C29HVh",
    "img": "img/EarFunAirPro_4.png",
    "off": "https://x.gd/zzeqg"
}, {
    "name": "EAH-AZ100",
    "price_range": "3万円以上",
    "noise": "欲しい",
    "noisepower": "強い",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "39,600",
    "url": "https://amzn.asia/d/dPXqvP9",
    "img": "img/EAH-AZ100.png",
    "off": "https://jp.technics.com/products/tws/az100/"
}, {
    "name": "EAH-AZ80",
    "price_range": "2万円以上",
    "noise": "欲しい",
    "noisepower": "強い",
    "purpose": "通勤",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "29,700",
    "url": "https://amzn.asia/d/cvqAeZZ",
    "img": "img/EAH-AZ80.png",
    "off": "https://jp.technics.com/products/tws/az80/"
}, {
    "name": "EAH-AZ60M2",
    "price_range": "2万円以上",
    "noise": "欲しい",
    "noisepower": "強い",
    "purpose": "通勤",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "21,780",
    "url": "https://amzn.asia/d/euXH6if",
    "img": "img/EAH-AZ60M2.png",
    "off": "https://jp.technics.com/products/tws/az60m2/"
}, {
    "name": "EAH-AZ40M2",
    "price_range": "1万円以上",
    "noise": "欲しい",
    "noisepower": "中程度",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "14,850",
    "url": "https://amzn.asia/d/4poMPnL",
    "img": "img/EAH-AZ40M2.png",
    "off": "https://jp.technics.com/products/tws/az40m2/"
}, {
    "name": "OpenFit2+",
    "price_range": "2万円以上",
    "noise": "いらない",
    "noisepower": "弱い",
    "purpose": "運動",
    "type": "なし",
    "playtime": "11~15時間",
    "prise": "27,800",
    "url": "https://amzn.asia/d/1t2tkbU",
    "img": "img/OpenFit2+.png",
    "off": "https://jp.shokz.com/products/openfit2plus"
}, {
    "name": "OpenFitAir",
    "price_range": "1万円以上",
    "noise": "いらない",
    "noisepower": "弱い",
    "purpose": "運動",
    "type": "なし",
    "playtime": "5~10時間",
    "prise": "19,880",
    "url": "https://amzn.asia/d/aYlcPnK",
    "img": "img/OpenFitAir.png",
    "off": "https://jp.shokz.com/products/openfit-air"
}, {
    "name": "WF-1000XM5",
    "price_range": "3万円以上",
    "noise": "欲しい",
    "noisepower": "強い",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "11~15時間",
    "prise": "39,600",
    "url": "https://amzn.asia/d/5VjB7Us",
    "img": "img/WF-1000XM5.png",
    "off": "https://www.sony.jp/headphone/special/WF-1000XM5/"
}, {
    "name": "LinkBudsFit",
    "price_range": "2万円以上",
    "noise": "欲しい",
    "noisepower": "中程度",
    "purpose": "通勤",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "29,700",
    "url": "https://amzn.asia/d/ffjic7K",
    "img": "img/LinkBudsFit.png",
    "off": "https://www.sony.jp/headphone/special/LinkBuds_Fit/"
}, {
    "name": "WF-C710N",
    "price_range": "1万円以上",
    "noise": "欲しい",
    "noisepower": "中程度",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "17,600",
    "url": "https://amzn.asia/d/cThOyXl",
    "img": "img/WF-C710N.png",
    "off": "https://www.sony.jp/headphone/products/WF-C710N/"
}, {
    "name": "WF-C510",
    "price_range": "1万円以下",
    "noise": "いらない",
    "noisepower": "弱い",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "11~15時間",
    "prise": "9900",
    "url": "https://amzn.asia/d/27auwtv",
    "img": "img/WF-C510.png",
    "off": "https://www.sony.jp/headphone/products/WF-C510/"
}, {
    "name": "WF-G700N",
    "price_range": "2万円以上",
    "noise": "欲しい",
    "noisepower": "強い",
    "purpose": "ゲーム",
    "type": "あり",
    "playtime": "11~15時間",
    "prise": "29,700",
    "url": "https://amzn.asia/d/abAT49v",
    "img": "img/WF-G700N.png",
    "off": "https://www.sony.jp/inzone/special/INZONE_BUDS/?s_pid=jp_/inzone/_products_bads"
}, {
    "name": "ATH-TWX9MK2",
    "price_range": "3万円以上",
    "noise": "欲しい",
    "noisepower": "強い",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "38,500",
    "url": "https://amzn.asia/d/81LdzRF",
    "img": "img/ATH-TWX9MK2.png",
    "off": "https://www.audio-technica.co.jp/product/ATH-TWX9MK2"
}, {
    "name": "ATH-CKS50TW2",
    "price_range": "2万円以上",
    "noise": "欲しい",
    "noisepower": "中程度",
    "purpose": "通勤",
    "type": "あり",
    "playtime": "16時間以上",
    "prise": "23,980",
    "url": "https://amzn.asia/d/5FzYhYa",
    "img": "img/ATH-CKS50TW2.png",
    "off": "https://www.audio-technica.co.jp/product/ATH-CKS50TW2"
}, {
    "name": "ATH-CKS30TW+",
    "price_range": "1万円以上",
    "noise": "欲しい",
    "noisepower": "中程度",
    "purpose": "通勤",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "13,970",
    "url": "https://www.amazon.co.jp/dp/B0D53S5CKD?ref=emc_p_m_5_i_atc&th=1",
    "img": "img/ATH-CKS30TW+.png",
    "off": "https://www.audio-technica.co.jp/product/ATH-CKS30TWplus"
}, {
    "name": "ATH-TWX7",
    "price_range": "2万円以上",
    "noise": "欲しい",
    "noisepower": "強い",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "26,400",
    "url": "https://www.amazon.co.jp/dp/B0CK8CTVBL?ref=emc_s_m_5_i_atc&th=1",
    "img": "img/ATH-TWX7.png",
    "off": "https://www.audio-technica.co.jp/product/ATH-TWX7"
}, {
    "name": "TE-W1-PNK",
    "price_range": "1万円以上",
    "noise": "欲しい",
    "noisepower": "中程度",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "16時間以上",
    "prise": "19,800",
    "url": "https://amzn.asia/d/0VwVCQK",
    "img": "img/TE-W1-PNK.png",
    "off": "https://aviot.jp/product/te-w1-pnk/"
}, {
    "name": "TE-A1",
    "price_range": "1万円以上",
    "noise": "欲しい",
    "noisepower": "弱い",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "16時間以上",
    "prise": "15,950",
    "url": "https://amzn.asia/d/d5SzCN8",
    "img": "img/TE-A1.png",
    "off": "https://aviot.jp/product/te-a1/"
}, {
    "name": "TOURPRO 3",
    "price_range": "3万円以上",
    "noise": "欲しい",
    "noisepower": "強い",
    "purpose": "音楽鑑賞",
    "type": "あり",
    "playtime": "11~15時間",
    "prise": "39,600",
    "url": "https://amzn.asia/d/jjFyjHe",
    "img": "img/TOURPRO_3.png",
    "off": "https://x.gd/9pk4o"
}, {
    "name": "QuietComfortUltraEarbuds (第二世代)",
    "price_range": "3万円以上",
    "noise": "欲しい",
    "noisepower": "強い",
    "purpose": "通勤",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "39,600",
    "url": "https://amzn.asia/d/fXAmeLp",
    "img": "img/QuietComfortUltraEarbuds_Dainisedai.png",
    "off": "https://x.gd/N6cOi"
}, {
    "name": "Arctis GameBuds",
    "price_range": "2万円以上",
    "noise": "欲しい",
    "noisepower": "中程度",
    "purpose": "ゲーム",
    "type": "あり",
    "playtime": "5~10時間",
    "prise": "25,480",
    "url": "https://amzn.asia/d/5AZydM6",
    "img": "img/Arctis_GameBuds.png",
    "off": "https://jp.steelseries.com/arctisgamebuds"
}];

const questions = [{
    "key": "purpose",
    "text": "用途は何ですか?",
    "values": ["運動", "音楽鑑賞", "通勤", "ゲーム"]
}, {
    "key": "price_range",
    "text": "どの価格帯がいいですか?",
    "values": ["1万円以下", "1万円以上", "2万円以上", "3万円以上"]
}, {
    "key": "noise",
    "text": "ノイズキャンセルは欲しいですか?",
    "values": ["欲しい", "いらない"]
}, {
    "key": "noisepower",
    "text": "ノイズキャンセリングの強さは?",
    "values": ["強い", "中程度", "弱い"]
}, {
    "key": "type",
    "text": "イヤーピースはありかなしか?",
    "values": ["あり", "なし", "その他"]
}, {
    "key": "playtime",
    "text": "連続再生時間(イヤホン単位)は何時間がいいですか?",
    "values": ["5~10時間", "11~15時間", "16時間以上"]
}];

let step = 0;
let candidates = [];
let history = [];

const questionText = document.getElementById('question');
const answerButtons = document.getElementById('answer-buttons');
const questionArea = document.getElementById('question-area');
const resultArea = document.getElementById('result-area');
const resultList = document.getElementById('result-list');
const backButton = document.getElementById('back-button');

function initializeData() {
    candidates = [...products];
    showQuestion();
}

function showQuestion() {
    if (step >= questions.length || candidates.length <= 1) {
        return showResult();
    }

    backButton.style.display = step > 0 ? 'inline-block' : 'none';

    const currentQuestion = questions[step];
    questionText.textContent = currentQuestion.text;
    answerButtons.innerHTML = '';

    const availableValues = new Set();
    candidates.forEach(product => {
        const value = product[currentQuestion.key];
        if (value !== "" && value !== undefined && value !== null) {
            availableValues.add(value);
        }
    }
    );

    if (availableValues.size === 1) {
        step++;
        showQuestion();
        return;
    }

    currentQuestion.values.forEach( (option, index) => {
        if (availableValues.has(option)) {
            const button = document.createElement('button');
            button.textContent = option;
            button.onclick = () => handleAnswer(option);
            answerButtons.appendChild(button);
        }
    }
    );
}

function handleAnswer(value) {
    const currentQuestion = questions[step];

    history.push({
        step: step,
        candidates: [...candidates]
    });

    candidates = candidates.filter(product => {
        if (!(currentQuestion.key in product)) {
            console.log(`商品 ${product.name} には属性 ${currentQuestion.key} がありません`);
            return false;
        }

        const productValue = product[currentQuestion.key];

        if (productValue === "" || productValue === undefined || productValue === null) {
            if (currentQuestion.key === "noisepower" && product.noise === "いらない" && (value === "弱い" || value === "中程度" || value === "強い")) {
                return false;
            }
            return false;
        }

        return productValue === value;
    }
    );

    step++;
    showQuestion();
}

function showResult() {
    questionArea.style.display = "none";
    resultArea.style.display = "block";

    if (candidates.length > 0) {
        resultList.innerHTML = candidates.map(product => `<li id="product-item">
                <img src="${product.img}" width="100" height="auto" onerror="this.style.display='none'"><br>
                ${product.name}<br>
                <button class="amazon"><a href="${product.url}" target="_blank">Amazon</a><br></button>
                <button class="off"><a href="${product.off}" target="_blank">Website</a><br></button>
                <p>価格: ${product.prise}円</p>
            </li>`).join('');
    } else {
        resultList.innerHTML = "<li>一致する商品が見つかりませんでした。条件を変えてもう一度お試しください。</li>";
    }
}

function restart() {
    step = 0;
    candidates = [...products];
    history = [];
    questionArea.style.display = "block";
    resultArea.style.display = "none";
    showQuestion();
}

backButton.addEventListener('click', () => {
    if (history.length > 0) {
        const lastHistory = history.pop();
        step = lastHistory.step;
        candidates = [...lastHistory.candidates];

        showQuestion();
    }
}
);

document.addEventListener('DOMContentLoaded', () => {
    initializeData();
}
);
